{{define "jobs"}}
<div class="panel">
  <div class="panel-header">
    <div><strong>Jobs</strong><div class="help">Swipe through pending jobs</div></div>
  </div>
  <div class="panel-body">
    <div class="swipe-wrapper">
      {{if eq (len .Jobs) 0}}
      <div class="help">No pending jobs found.</div>
      {{else}}
      {{range $i, $j := .Jobs}}
      <div class="swipe-card" data-index="{{$i}}" {{if ne $i 0}}style="display:none" {{end}} id="job-{{$j.ID}}">
        <div class="swipe-head">
          <div class="swipe-title">{{$j.Title}}</div>
          <div class="swipe-meta">{{$j.CompanyName}} â€¢ {{$j.PostedAt}}</div>
          <div class="swipe-meta" style="font-size:12px;color:#cfe8ff">Resume: {{$j.ResumeID}}</div>
        </div>
        <div class="swipe-body">
          <div class="swipe-desc">{{$j.DescriptionText}}</div>
          <div class="swipe-link"><a href="{{$j.Link}}" target="_blank" rel="noopener">Job Link</a></div>
        </div>
        <div class="swipe-actions">
          <button class="ghost swipe-no" data-job="{{$j.ID}}" data-status="NOT_INTERESTED">Not Interested</button>
          <button class="swipe-yes" data-job="{{$j.ID}}" data-status="INTERESTED">Interested</button>
        </div>
      </div>
      {{end}}
      <div id="swipe-status" class="help" style="margin-top:12px"></div>
      {{end}}
    </div>
  </div>
</div>
<script>
  (function () {
    const cards = Array.from(document.querySelectorAll('.swipe-card')); let idx = 0;
    function show(n) {cards.forEach((c, i) => {c.style.display = i === n ? 'block' : 'none'});}    
    let refetchAttempts = 0; const maxRefetch = 3; let lastRefetch = 0; const refetchCooldown = 5000;
    function advance() {
      idx++;
      if (idx < cards.length) {show(idx); return;}
      const now = Date.now();
      const statusEl = document.getElementById('swipe-status');
      if (refetchAttempts >= maxRefetch) {statusEl.textContent = 'No more jobs available.'; return;}
      if (now - lastRefetch < refetchCooldown) {statusEl.textContent = 'Waiting for new jobs...'; setTimeout(() => advance(), refetchCooldown - (now - lastRefetch) + 50); return;}
      statusEl.textContent = 'Refreshing jobs...';
      lastRefetch = now; refetchAttempts++;
      htmx.ajax('GET', '/jobs', {
        target: '.swipe-wrapper', swap: 'innerHTML', handler: function () {
          const newCards = document.querySelectorAll('.swipe-card');
          if (!newCards.length) {
            if (refetchAttempts < maxRefetch) {statusEl.textContent = 'No pending jobs. Will retry...'; setTimeout(() => advance(), refetchCooldown);} else {statusEl.textContent = 'No pending jobs found.';}
          } else {
            // reset state with new deck
            cards.length = 0; Array.prototype.push.apply(cards, Array.from(newCards)); idx = 0; show(0);
            statusEl.textContent = '';
          }
        }, error: "<div class='alert'>Failed to fetch jobs.</div>"
      });
    }
    function postStatus(jobID, status, btn) {
      if (btn._clicked) return; btn._clicked = true; // guard
      const parent = btn.closest('.swipe-actions');
      parent.querySelectorAll('button').forEach(b => {b.disabled = true; b.style.opacity = '.6';});
      const statusEl = document.getElementById('swipe-status');
      statusEl.textContent = 'Updating...';
      htmx.ajax('POST', '/job/status', {target: '#swipe-status', swap: 'innerHTML', values: {jobID: jobID, status: status}});
    }
    document.body.addEventListener('htmx:afterOnLoad', function (evt) {
      if (evt.detail.target && evt.detail.target.id === 'swipe-status') {advance();}
    });
    document.querySelectorAll('.swipe-actions button').forEach(btn => {
      btn.addEventListener('click', function () {postStatus(this.dataset.job, this.dataset.status, this);});
    });
  })();
</script>
{{end}}
